// Глава 1: Введение в MongoDB (mongoose) - Моделирование Отзывы и Реферирование родителей

// MongoDB и mongoose позволяют нам создавать гибкие структуры данных для хранения и использования данных в приложении.
// В этой главе мы рассмотрим моделирование отзывов с использованием mongoose и установим связь с родительскими объектами, такими как `Tour` и `User`.

// Подключаем mongoose:
const mongoose = require("mongoose");

// Определяем схему для отзывов `reviewSchema`
// Эта схема включает свойства, такие как текст отзыва, рейтинг, дата создания, и ссылки на связанные туры и пользователей.
// Поля `tour` и `user` используют `ref`, чтобы указать mongoose на связанные модели.
const reviewSchema = new mongoose.Schema(
    {
        // Текст отзыва:
        review: {
            type: String,
            required: [true, "Review cannot be empty!"], // Обязательное поле
        },
        // Рейтинг:
        rating: {
            type: Number,
            min: 1, // Минимальный рейтинг
            max: 5, // Максимальный рейтинг
        },
        // Дата создания отзыва:
        createdAt: {
            type: Date,
            default: Date.now, // Устанавливаем текущую дату по умолчанию
        },
        // Ссылка на тур:
        tour: [
            {
                type: mongoose.Schema.ObjectId,
                ref: "Tour", // Ссылка на модель `Tour`
                required: [true, "Review must belong to a tour!"], // Обязательная связь
            },
        ],
        // Ссылка на пользователя:
        user: [
            {
                type: mongoose.Schema.ObjectId,
                ref: "User", // Ссылка на модель `User`
                required: [true, "Review must belong to a user!"], // Обязательная связь
            },
        ],
    },
    {
        // Настройки для виртуальных полей, которые будут видимыми при преобразовании в JSON и объект:
        toJSON: { virtuals: true },
        toObject: { virtuals: true },
    }
);

// Создаем модель на основе схемы `reviewSchema`
const Review = mongoose.model("Review", reviewSchema);

// Экспортируем модель `Review`, чтобы её можно было использовать в других модулях
module.exports = Review;

// Пояснения:
// - `reviewSchema` — это схема Mongoose для модели отзывов, которая определяет структуру и ограничения данных.
// - `tour` и `user` — это массивы, которые используют `ObjectId` для реферирования родительских документов, что позволяет mongoose легко связывать документы `Review` с `Tour` и `User`.
// - Использование `ref` упрощает возможность делать `populate()` на эти поля, чтобы загружать связанные данные, такие как подробная информация о туре или пользователе.

// Пример использования:
// Чтобы получить отзывы вместе с данными о пользователе и туре, можно использовать метод `.populate()`:
// Review.find().populate('tour').populate('user').then(reviews => console.log(reviews));

// Итог:
// Использование ссылок и схем в mongoose позволяет организовать данные в MongoDB так, чтобы можно было легко создавать сложные связи между документами, как в случае с отзывами, связанными с пользователями и турами.
