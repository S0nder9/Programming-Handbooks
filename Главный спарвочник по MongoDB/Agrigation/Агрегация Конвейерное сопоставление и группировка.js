// Глава 1: Введение в MongoDB - Агрегация
// Конвейерное сопоставление и группировка

// MongoDB предоставляет мощный механизм агрегации, который позволяет выполнять сложные операции обработки данных.
// В этой главе мы рассмотрим, как использовать конвейеры для сопоставления и группировки данных.

// Агрегация в MongoDB реализуется через конвейерные операции, которые позволяют последовательно обрабатывать данные.
// Каждый этап конвейера принимает входные данные, обрабатывает их и передает на следующий этап.
// Это особенно полезно для получения статистики и анализа данных.

// Пример использования агрегации в MongoDB для получения статистики по турам на основе рейтинга:
const stats = await Tour.aggregate([
    {
        // Этап $match - фильтруем документы по условию
        $match: { rating: { $gte: 4.5 } }, // выбираем только туры с рейтингом 4.5 и выше
    },
    {
        // Этап $group - группируем данные по полю "difficulty"
        $group: {
            _id: { $toUpper: "$difficulty" }, // преобразуем поле "difficulty" к верхнему регистру для группировки
            numTours: { $sum: 1 }, // подсчитываем количество туров в каждой группе
            numRatings: { $sum: "$ratingsQuantity" }, // суммируем количество рейтингов для каждой группы
            avgRating: { $avg: "$rating" }, // вычисляем средний рейтинг для каждой группы
            avgPrice: { $avg: "$price" }, // вычисляем среднюю цену для каждой группы
            minPrice: { $min: "$price" }, // находим минимальную цену для каждой группы
            maxPrice: { $max: "$price" }, // находим максимальную цену для каждой группы
        },
    },
    {
        // Этап $sort - сортируем результаты по средней цене
        $sort: {
            avgPrice: 1, // сортировка по возрастанию средней цены
        },
    },
]);

// Пример использования полученных данных:
console.log('Статистика по турам:', stats);

// Итог:
// Агрегация в MongoDB позволяет эффективно обрабатывать и анализировать данные с помощью конвейерных операций.
// В этом примере мы отфильтровали, сгруппировали и отсортировали данные о турах, что может помочь в принятии решений и анализе рынка.
