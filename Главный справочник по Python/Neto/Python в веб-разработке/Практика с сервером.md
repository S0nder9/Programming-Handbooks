# SSH (Secure Shell) и настройка сервера

Этот документ описывает протокол SSH для безопасного подключения к серверу, генерацию ключей, подключение к VPS и базовую настройку сервера (установка пакетов, PostgreSQL, клонирование репозитория, запуск Django-приложения). Все команды приведены для Unix-подобных систем (bash или аналогичных).

---

## SSH (Secure Shell)

**SSH** — протокол, обеспечивающий безопасное соединение между клиентом и сервером. Он используется для удалённого управления серверами, передачи файлов и выполнения команд.

### Генерация SSH-ключей

1. Выполните команду для генерации ключей:
   ```bash
   ssh-keygen -t ed25519
   ```
   - **Вывод примера:**
     ```
     Generating public/private ed25519 key pair.
     Enter file in which to save the key (/c/Users/npatr/.ssh/id_ed25519): pass
     Enter passphrase for "pass" (empty for no passphrase):
     Enter same passphrase again:
     Your identification has been saved in pass
     Your public key has been saved in pass.pub
     The key fingerprint is:
     SHA256:U2KwOcNxT3i/ESXcrktfvfA9PiXadbC9i22BuvhQOLU npatr@DESKTOP-QFD79SO
     The key's randomart image is:
     +--[ED25519 256]--+
     |      o .....o.  |
     |     . *.o. o..  |
     |      * o.oo o   |
     |       + oo + o  |
     |        So E +.+.|
     |         .o +oo.B|
     |         . ..=o+B|
     |          o.o =B.|
     |         ..o..o++|
     +----[SHA256]-----+
     ```

2. Проверьте сгенерированные ключи:
   ```bash
   ls ~/.ssh/
   ```
   - **Вывод:** `id_ed25519  id_ed25519.pub`

3. Отобразите публичный ключ:
   ```bash
   cat ~/.ssh/id_ed25519.pub
   ```
   - **Вывод примера:** `ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAINXwDjZq2D0KywjZKLWU7MCFq2N8q/051tMC+QszqwL9 npatr@DESKTOP-QFD79SO`

4. Добавьте публичный ключ в настройки хостинга (например, в Reg.ru или GitHub):
   - Скопируйте ключ (`AAAAC3NzaC1lZDI1NTE5AAAAINXwDjZq2D0KywjZKLWU7MCFq2N8q/051tMC+QszqwL9`) и вставьте в раздел SSH-ключей.

5. Создайте VPS-ресурс (например, в Reg.ru) и дождитесь информации о сервере (IP-адрес, логин, пароль) на почту.

6. Подключитесь к серверу:
   ```bash
   ssh root@192.168.0.100  # Замените root на имя пользователя и IP на реальный
   ```
   - Введите пароль (если ключ не используется) или passphrase для ключа.

**Пояснение:** После первого подключения сервер добавляется в `~/.ssh/known_hosts` для безопасности.

---

## Настройка сервера

После подключения к VPS настройте сервер для запуска Django-приложения.

### 1. Проверка установленных пакетов
```bash
git --version  # Проверка Git
python3 --version  # Проверка Python
```

### 2. Обновление системы и установка пакетов
```bash
sudo apt update  # Обновление списка пакетов
sudo apt install python3-venv python3-pip postgresql  # Установка виртуального окружения, pip и PostgreSQL
```

### 3. Управление PostgreSQL
```bash
sudo systemctl start postgresql  # Запуск PostgreSQL
sudo systemctl restart postgresql  # Перезапуск PostgreSQL
sudo systemctl status postgresql  # Проверка статуса
```

### 4. Создание пользователя (рекомендуется для безопасности)
```bash
sudo adduser name  # Создание пользователя
sudo usermod -aG sudo name  # Добавление в группу sudo
sudo passwd name  # Смена пароля
sudo -i -u name  # Вход от имени пользователя
```

**Пояснение:** Не работайте под `root` для безопасности; используйте отдельного пользователя.

### 5. Настройка PostgreSQL
```bash
sudo su postgres  # Вход в PostgreSQL от имени пользователя postgres
```
В терминале PostgreSQL:
```sql
ALTER USER postgres WITH PASSWORD 'postgres';  # Смена пароля (замените 'postgres' на реальный)
CREATE DATABASE test_db;  # Создание базы данных
\q  # Выход
```

### 6. Клонирование репозитория и запуск приложения
```bash
git clone https://github.com/npatr/django_cicd.git  # Клонирование репозитория
cd django_cicd  # Переход в директорию проекта
```

### 7. Настройка виртуального окружения
```bash
python3 -m venv env  # Создание виртуального окружения
source env/bin/activate  # Активация окружения
pip install -r requirements.txt  # Установка зависимостей
pip freeze  # Проверка установленных пакетов
```

### 8. Настройка базы данных
В файле `stocks_products/settings.py` укажите параметры базы данных:
```python
import os

DATABASES = {
    'default': {
        'ENGINE': os.getenv("DB_ENGINE", default="django.db.backends.postgresql"),
        'NAME': os.getenv("DB_NAME"),
        'USER': os.getenv("DB_USER"),
        'PASSWORD': os.getenv("DB_PASSWORD"),
        'HOST': os.getenv("DB_HOST"),
        'PORT': os.getenv("DB_PORT"),
    }
}
```

Создайте файл `.env` в корне проекта и добавьте переменные:
```env
DB_ENGINE=django.db.backends.postgresql
DB_NAME=test_db
DB_USER=postgres
DB_PASSWORD=your_password
DB_HOST=localhost
DB_PORT=5432
```

### 9. Запуск миграций и сервера
```bash
python manage.py migrate  # Применение миграций
python manage.py runserver 0.0.0.0:8000  # Запуск сервера, доступного с любого IP
```

**Доступ к серверу:** Откройте в браузере `http://192.168.0.100:8000/` (замените IP на реальный).

**Пояснение:** `0.0.0.0:8000` позволяет подключаться к серверу с внешних IP-адресов.

---

## Рекомендации по работе

1. **Безопасность SSH:**
   - Используйте ключи вместо паролей для подключения.
   - Добавьте passphrase к ключу для дополнительной защиты.
   - Настройте firewall на сервере:
     ```bash
     sudo ufw allow ssh
     sudo ufw enable
     ```

2. **Управление пользователем:**
   - Работайте от имени обычного пользователя, а не `root`.
   - Добавьте SSH-ключ для нового пользователя:
     ```bash
     sudo mkdir -p /home/name/.ssh
     sudo chown name:name /home/name/.ssh
     echo "your_public_key" >> /home/name/.ssh/authorized_keys
     ```

3. **PostgreSQL:**
   - Настройте внешний доступ в `/etc/postgresql/<version>/main/postgresql.conf` и `pg_hba.conf`.
   - Используйте сильные пароли и ограничьте доступ по IP.

4. **Django на сервере:**
   - Используйте Gunicorn + Nginx для продакшена вместо `runserver`.
   - Добавьте переменные окружения в `.env` и загрузите их с помощью `python-dotenv`:
     ```powershell
     pip install python-dotenv
     ```
     ```python
     # settings.py
     from dotenv import load_dotenv
     load_dotenv()
     ```

5. **Отладка:**
   - Проверяйте логи PostgreSQL:
     ```bash
     sudo journalctl -u postgresql
     ```
   - Если сервер не доступен, проверьте firewall и порты:
     ```bash
     sudo ufw allow 8000
     ```

6. **Автоматизация:**
   - Используйте Ansible или Fabric для автоматизации настройки серверов.
   - Для CI/CD настройте GitHub Actions для деплоя на VPS.