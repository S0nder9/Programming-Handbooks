# Деплой Django-приложения с использованием Gunicorn и Nginx

Этот документ описывает процесс деплоя Django-приложения на VPS с использованием SSH, настройку PostgreSQL, Gunicorn для WSGI и Nginx для обработки статического контента, а также рекомендации по выбору облачных решений. Также рассматриваются решения проблем, таких как ручной запуск и использование `runserver` в продакшене.

---

## Пошаговая настройка сервера

### 1. Подключение к серверу
```bash
ssh root@192.168.0.100
```

**Пояснение:** Используйте IP-адрес вашего сервера и имя пользователя (например, `root`). Если настроены SSH-ключи, пароль не потребуется.

---

### 2–4. Создание пользователя
```bash
sudo adduser user  # Создание нового пользователя
sudo usermod -aG sudo user  # Добавление в группу sudo
```

**Пояснение:** Работа под `root` небезопасна. Создайте пользователя и добавьте его в группу `sudo` для выполнения административных задач.

---

### 5. Переход в домашнюю директорию
```bash
cd ~
```

---

### 6–7. Обновление и установка пакетов
```bash
sudo apt update
sudo apt install python3-venv python3-pip postgresql nginx
```

**Пояснение:** Устанавливаются Python, виртуальное окружение, pip, PostgreSQL и Nginx (веб-сервер для обработки статических файлов и проксирования).

---

### 8–9. Запуск сервисов
```bash
sudo systemctl start postgresql
sudo systemctl start nginx
```

**Пояснение:** Nginx — веб-сервер, взаимодействующий с Django через WSGI/ASGI. PostgreSQL — база данных.

---

### 10. Проверка статуса Nginx
```bash
sudo systemctl status nginx
```
Или откройте в браузере: `http://192.168.0.100`

**Пояснение:** Если Nginx работает, вы увидите стартовую страницу.

---

### 11–12. Клонирование репозитория
```bash
git clone https://github.com/npatr/django_cicd.git
cd django_cicd
```

---

### 13–17. Настройка PostgreSQL
```bash
sudo su postgres
psql
```
В PostgreSQL:
```sql
ALTER USER postgres WITH PASSWORD 'postgres12';
CREATE DATABASE test_db;
\q
```

**Пояснение:** Устанавливается пароль для пользователя `postgres` и создаётся база данных `test_db`.

---

### 18–20. Настройка Django
Перейдите в директорию проекта:
```bash
cd ~/django_cicd
```

Отредактируйте `stocks_products/settings.py`:
```python
import os
from dotenv import load_dotenv

load_dotenv()

DATABASES = {
    'default': {
        'ENGINE': os.getenv("DB_ENGINE", default="django.db.backends.postgresql"),
        'NAME': os.getenv("DB_NAME"),
        'USER': os.getenv("DB_USER"),
        'PASSWORD': os.getenv("DB_PASSWORD"),
        'HOST': os.getenv("DB_HOST"),
        'PORT': os.getenv("DB_PORT"),
    }
}

SECRET_KEY = os.getenv("SECRET_KEY")
DEBUG = os.getenv("DEBUG") == "True"
ALLOWED_HOSTS = os.getenv("ALLOWED_HOSTS", "").split(",")
```

Создайте файл `.env`:
```bash
nano .env
```
Содержимое:
```env
SECRET_KEY=123456789
DEBUG=True
ALLOWED_HOSTS=192.168.0.100
DB_ENGINE=django.db.backends.postgresql
DB_NAME=test_db
DB_USER=postgres
DB_PASSWORD=postgres12
DB_HOST=localhost
DB_PORT=5432
```

**Пояснение:** Переменные окружения хранят чувствительные данные, такие как ключи и пароли.

---

### 21–24. Настройка виртуального окружения
```bash
python3 -m venv env
source env/bin/activate
pip install -r requirements.txt
pip freeze
```

**Пояснение:** Создаётся изолированное окружение, устанавливаются зависимости из `requirements.txt`.

---

### 25–26. Запуск миграций и сервера
```bash
python manage.py migrate
python manage.py runserver 0.0.0.0:8000
```

**Проблемы:**
1. **Ручной запуск:** `runserver` требует постоянного запуска вручную.
2. **Неподходящий для продакшена:** `runserver` не предназначен для высоконагруженных приложений.

**Решения:**
- Используйте **Gunicorn** (WSGI-сервер) + **Nginx** для продакшена.
- Рассмотрите облачные решения (см. ниже).

---

## Настройка Gunicorn (WSGI)

**Gunicorn** — это WSGI-сервер, который запускает Django-приложение в продакшене, создавая несколько процессов для обработки запросов.

### 27–29. Установка и запуск Gunicorn
```bash
source env/bin/activate
pip install gunicorn
gunicorn stocks_products.wsgi:application -b 0.0.0.0:8000 --workers=$((2 * $(nproc) + 1))
```

**Пояснение:** Количество workers рассчитывается как `(2 * число_ядер + 1)` для оптимальной производительности.

---

### 30–32. Настройка Gunicorn как сервиса
Создайте файл конфигурации:
```bash
sudo nano /etc/systemd/system/gunicorn.service
```

Содержимое:
```ini
[Unit]
Description=Gunicorn service
After=network.target

[Service]
User=user
Group=www-data
WorkingDirectory=/home/user/django_cicd
ExecStart=/home/user/django_cicd/env/bin/gunicorn --workers 3 --bind unix:/home/user/django_cicd/stocks_products/project.sock stocks_products.wsgi:application

[Install]
WantedBy=multi-user.target
```

Запустите и включите сервис:
```bash
sudo systemctl start gunicorn
sudo systemctl enable gunicorn
sudo systemctl status gunicorn
```

**Если статус `failed`:**
- Проверьте логи: `sudo journalctl -u gunicorn`
- Исправьте ошибки (например, пути или права доступа) и перезапустите:
  ```bash
  sudo systemctl restart gunicorn
  ```

---

## Настройка Nginx

Nginx обрабатывает статические файлы и проксирует запросы к Gunicorn.

### 33–35. Конфигурация Nginx
Создайте конфигурационный файл:
```bash
sudo nano /etc/nginx/sites-available/project.conf
```

Содержимое:
```nginx
server {
    listen 80;
    server_name 192.168.0.100;

    location /static/ {
        root /home/user/django_cicd;
    }

    location /media/ {
        root /home/user/django_cicd;
    }

    location / {
        include proxy_params;
        proxy_pass http://unix:/home/user/django_cicd/stocks_products/project.sock;
    }
}
```

Создайте символическую ссылку:
```bash
sudo ln -s /etc/nginx/sites-available/project.conf /etc/nginx/sites-enabled/project.conf
```

Перезапустите Nginx:
```bash
sudo systemctl restart nginx
sudo systemctl status nginx
```

---

### Устранение ошибок
**Ошибка 502 Bad Gateway:**
1. Проверьте файл `/etc/nginx/nginx.conf`:
   ```bash
   sudo nano /etc/nginx/nginx.conf
   ```
   Измените пользователя:
   ```nginx
   user user;
   ```
2. Перезапустите Nginx:
   ```bash
   sudo systemctl restart nginx
   ```

---

## Работа со статическими файлами

В продакшене статические файлы (`static/`, `media/`) обслуживаются Nginx, а не Django.

### 37. Сбор статических файлов
В `settings.py` настройте:
```python
STATIC_URL = '/static/'
STATIC_ROOT = BASE_DIR / 'static'
MEDIA_URL = '/media/'
MEDIA_ROOT = BASE_DIR / 'media'
```

Соберите статические файлы:
```bash
python manage.py collectstatic
```

**Пояснение:** Команда `collectstatic` копирует все статические файлы в `STATIC_ROOT`.

---

## Облачные решения для деплоя

Для упрощения деплоя можно использовать облачные платформы, которые автоматизируют настройку сервера, масштабирование и управление.

### Варианты
1. **Google Cloud App Engine**:
   - Подходит для быстрого деплоя Django-приложений.
   - Автоматическое масштабирование.
   - Требует настройки `app.yaml`:
     ```yaml
     runtime: python39
     instance_class: F1
     env_variables:
       DB_NAME: "test_db"
       DB_USER: "postgres"
     ```

2. **AWS Elastic Beanstalk**:
   - Поддерживает Python и Django.
   - Требует настройки через EB CLI:
     ```bash
     eb init -p python-3.9 project-name --region us-east-1
     eb create project-env
     ```

3. **Microsoft Azure App Service**:
   - Простая интеграция с Django через Git.
   - Поддержка PostgreSQL.
   - Используйте Azure CLI:
     ```bash
     az webapp up --sku B1 --name project-name
     ```

4. **IBM Cloud**:
   - Подходит для сложных приложений с Kubernetes.
   - Требует больше настройки.

5. **Oracle Cloud**:
   - Бесплатный уровень для небольших приложений.
   - Поддержка контейнеров (Docker).

### Как выбрать?
- **Google Cloud App Engine**: Лучше для начинающих, минимальная настройка, автоматическое масштабирование.
- **AWS**: Подходит для крупных проектов, но требует больше знаний.
- **Azure**: Хороший выбор для интеграции с Microsoft-продуктами.
- **IBM/Oracle**: Для специфичных случаев или бесплатного уровня.

**Рекомендация:** Для простоты начните с Google Cloud App Engine или Heroku (хотя Heroku не упомянут, он популярен).

---

## Резюме

1. **Ручной деплой (VPS):**
   - Настройка SSH, PostgreSQL, Gunicorn, Nginx.
   - Подходит для полного контроля над сервером.
   - Требует ручной настройки и обслуживания.

2. **Проблемы ручного деплоя:**
   - Ручной запуск `runserver`.
   - `runserver` не подходит для продакшена (не масштабируется, не оптимизирован).

3. **Решение: Gunicorn + Nginx**
   - Gunicorn запускает Django-приложение через WSGI.
   - Nginx обслуживает статические файлы и проксирует запросы.
   - Автоматизация через systemd-сервис.

4. **Облачные решения:**
   - Упрощают деплой и масштабирование.
   - Подходят для быстрого старта или крупных проектов.

5. **Рекомендации:**
   - Используйте `.env` для хранения конфиденциальных данных.
   - Настройте HTTPS для продакшена (Let’s Encrypt).
   - Автоматизируйте деплой с помощью CI/CD (GitHub Actions, GitLab CI).